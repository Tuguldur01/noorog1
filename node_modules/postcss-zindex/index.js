'use strict';

var postcss = require('postcss');

<<<<<<< HEAD
module.exports = postcss.plugin('postcss-zindex', function (opts) {
    opts = opts || {};
    return function (css) {
        var cache = require('./lib/layerCache')(opts);
=======
module.exports = postcss.plugin('postcss-zindex', function () {
    return function (css) {
        var cache = require('./lib/layerCache')();
>>>>>>> 5a88520246291938171233a829a6c8d57a25619b
        var nodes = [];
        var abort = false;
        // First pass; cache all z indexes
        css.walkDecls('z-index', function (decl) {
<<<<<<< HEAD
=======
            if (abort) {
                return;
            }
>>>>>>> 5a88520246291938171233a829a6c8d57a25619b
            // Check that no negative values exist. Rebasing is only
            // safe if all indices are positive numbers.
            if (decl.value[0] === '-') {
                abort = true;
<<<<<<< HEAD
                // Stop PostCSS iterating through the rest of the decls
                return false;
=======
                return;
>>>>>>> 5a88520246291938171233a829a6c8d57a25619b
            }
            nodes.push(decl);
            cache.addValue(decl.value);
        });
<<<<<<< HEAD

        // Abort if we found any negative values
        // or there are no z-index declarations
        if (abort || !nodes.length) {
=======
        
        // Abort rebasing altogether due to z-index being found
        if (abort) {
>>>>>>> 5a88520246291938171233a829a6c8d57a25619b
            return;
        }

        cache.optimizeValues();

        // Second pass; optimize
        nodes.forEach(function (decl) {
            // Need to coerce to string so that the
            // AST is updated correctly
<<<<<<< HEAD
            decl.value = cache.getValue(decl.value).toString();
=======
            var value = cache.getValue(decl.value);
            decl.value = String(value);
>>>>>>> 5a88520246291938171233a829a6c8d57a25619b
        });
    };
});
